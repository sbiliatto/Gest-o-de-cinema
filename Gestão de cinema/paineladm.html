<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Painel Administrativo | PrimeCine</title>
    <link rel="stylesheet" href="assets/css/paineladm.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/js/seguranca-adm.js" defer></script>
</head>

<body>
    <header class="header">
        <a href="homeeae.html" class="logo-link">
            <img class="logo" src="assets/img/PRIME CINE logo.png" alt="Logo empresarial" />
        </a>

        <div class="div-header">
            <div class="btn-group">
                <button type="button" class="btn btn-secondary dropdown-toggle bg-black border-2"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    MENU
                </button>
                <ul class="dropdown-menu dropdown-menu-end menu-escuro">
                    <li><a class="dropdown-item" href="promoadm.html">PROMO√á√ïES</a></li>
                    <li><a class="dropdown-item" href="relatorios_adm.html">RELAT√ìRIO</a></li>
                    <li><a class="dropdown-item" href="homeeae.html">HOME</a></li>
                    <li><a class="dropdown-item" href="listagem.html">LISTAGEM</a></li>
                    <li><a class="dropdown-item" href="adicsessao.html">ADICIONAR SESS√ÉO</a></li>
                    <li><a class="dropdown-item" href="adcsala.html">ADICIONAR SALA</a></li>
                    <li><a class="dropdown-item" href="paineladm.html">PAINEL ADMINISTRATIVO</a></li>
                    <li><a class="dropdown-item" href="configPix.html">CONFIGURAR PIX</a></li>
                </ul>
            </div>

            <div class="acao">
                <div class="perfil-container">
                    <img onclick="toggleMenu()" class="btn-perfil2" src="assets/img/do-utilizador.png" alt="Perfil" />
                    <div class="menu-perfil" id="menuPerfil">
                        <p>Ol√°, <span class="nome-veisitante" id="nome-visitante">(Nome do visitante)</span></p>
                        <ul>
                            <li><a href="meusPedidos.html">üì¶ Meus Pedidos</a></li>
                            <li><a href="editaradm.html">‚úèÔ∏è Editar perfil</a></li>
                            <li><a href="login.html" onclick="sair()">üö™ Sair da Conta</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="barra"></div>


    <main class="dashboard-container">
        <h1 class="tt">Painel Administrativo</h1>

        <section class="cards">
            <div class="card">
                <div class="card-content">
                    <h2 id="valor-arrecadado">R$ 45.320,00</h2>
                    <p>Valor Arrecadado</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#modalFiltrarData">
                        Filtrar por data
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <h2 id="ingressos-vendidos">1.230</h2>
                    <p>Ingressos Vendidos</p>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <h2>Top Bilheteria</h2>
                    <ul id="ranking-filmes">
                        <li>1. Filme A ‚Äì R$ 12.000</li>
                        <li>2. Filme B ‚Äì R$ 9.800</li>
                        <li>3. Filme C ‚Äì R$ 7.500</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="tabela-sessoes">
            <div class="tabela-header">
                <h2>Vendas por Sess√£o</h2>
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalVerTodas">
                    Ver todas
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Hor√°rio</th>
                        <th>Filme</th>
                        <th>Ingressos</th>
                    </tr>
                </thead>
                <tbody id="vendas-sessoes">
                    <tr>
                        <td>14h</td>
                        <td>Filme A</td>
                        <td>150</td>
                    </tr>
                    <tr>
                        <td>17h</td>
                        <td>Filme B</td>
                        <td>230</td>
                    </tr>
                    <tr>
                        <td>20h</td>
                        <td>Filme C</td>
                        <td>310</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <div class="modal fade" id="modalFiltrarData" tabindex="-1" aria-labelledby="modalFiltrarDataLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modalFiltrarDataLabel">Filtrar por Data</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="formFiltrarData">
                        <div class="mb-3">
                            <label for="dataInicio" class="form-label">Data In√≠cio</label>
                            <input type="date" class="form-control" id="dataInicio" required />
                        </div>
                        <div class="mb-3">
                            <label for="dataFim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="dataFim" required />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" form="formFiltrarData" class="btn btn-danger">Aplicar Filtro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver todas -->
    <div class="modal fade" id="modalVerTodas" tabindex="-1" aria-labelledby="modalVerTodasLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modalVerTodasLabel">Todas as Vendas</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>Aqui voc√™ pode ver todas as vendas registradas.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="btnBaixarPDF">Baixar PDF</button>
                </div>
            </div>
        </div>
    </div>

    <br><br>

    <div class="barra"></div>

    <footer class="main_footer_container">
        <div class="content">
            <div class="colfooter">
                <h3 class="titleFooter"> Menu</h3>
                <ul>
                    <li><a href="#" title="P√°gina In√≠cial">P√°gina In√≠cial</a></li>
                    <li><a href="promo√ß√µes.html" title="Promo√ß√µes">Promo√ß√µes</a></li>
                    <li><a href="relatorios.html" title="Relat√≥rio">Relat√≥rio</a></li>
                    <li><a href="cadastro.html" title="Cadastro">Cadastro</a></li>
                </ul>
            </div>
            <div class="colfooter">
                <h3 class="titleFooter"> Contato</h3>
                <p><i class="icon icon-mail"></i>primecine@gmail.com</p>
                <p><i class="icon icon-phone"></i> (00) 00000-0000</p>
                <p><i class="icon icon-whatsapp"></i> (11) 11111-1111</p>
            </div>
            <div class="colfooter">
                <h3 class="titleFooter"> Redes Sociais</h3>
                <div>
                    <a class="rss" href="https://www.instagram.com/">
                        <img src="assets/img/instagram.png" alt="Instagram">
                    </a>
                    <a class="rss" href="https://www.whatsapp.com/?lang=pt_BR">
                        <img src="assets/img/whatsapp (1).png" alt="WhatsApp">
                    </a>
                    <a class="rss" href="https://x.com/?lang=pt">
                        <img src="assets/img/twitter.png" alt="Twitter">
                    </a>
                    <a class="rss" href="https://www.facebook.com/?locale=pt_BR">
                        <img src="assets/img/facebook.png" alt="Facebook">
                    </a>
                </div>
            </div>
            <div class="clear"></div>
        </div>
        <div class="main_footer_copy">
            <p class="m-b-footer"> PrimeCine - 2025 ¬© todos os direitos reservados</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        function formatarMoedaBR(valor) {
            return valor.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        async function buscarDadosDoBackend(data_inicial, data_final) {
            try {
                const response = await fetch('http://127.0.0.1:5000/painel-admin', {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data_inicial, data_final })
                });

                if (!response.ok) {
                    throw new Error('Erro ao buscar dados do backend');
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error(error);
                Swal.fire('Erro', 'N√£o foi poss√≠vel buscar os dados.', 'error');
                return null;
            }
        }

function atualizarDashboard(dados) {
    if (!dados) return;

    const valorArrecadadoElem = document.getElementById('valor-arrecadado');
    valorArrecadadoElem.textContent = formatarMoedaBR(dados.total_arrecadado || 0);

    const ingressosVendidosElem = document.getElementById('ingressos-vendidos');
    ingressosVendidosElem.textContent = dados.ingressos_vendidos ?? 0;

    const rankingFilmesElem = document.getElementById('ranking-filmes');
    rankingFilmesElem.innerHTML = '';

    if (dados.filmes_mais_bilheteira && dados.filmes_mais_bilheteira.length > 0) {
        dados.filmes_mais_bilheteira.forEach((filme, index) => {
            const li = document.createElement('li');
            li.textContent = `${index + 1}. ${filme.titulo} ‚Äì ${formatarMoedaBR(filme.bilheteira_total)}`;
            rankingFilmesElem.appendChild(li);
        });
    } else {
        const li = document.createElement('li');
        li.textContent = 'Nenhum filme registrado (R$ 0)';
        rankingFilmesElem.appendChild(li);
    }

    const vendasSessoesBody = document.getElementById('vendas-sessoes');
    vendasSessoesBody.innerHTML = '';

    if (dados.vendas_por_sessao && dados.vendas_por_sessao.length > 0) {
        dados.vendas_por_sessao.forEach(sessao => {
            const tr = document.createElement('tr');

            const tdHorario = document.createElement('td');
            tdHorario.textContent = sessao.horario;
            tr.appendChild(tdHorario);

            const tdFilme = document.createElement('td');
            tdFilme.textContent = sessao.nome;
            tr.appendChild(tdFilme);

            const tdIngressos = document.createElement('td');
            tdIngressos.textContent = sessao.ingressos;
            tr.appendChild(tdIngressos);

            vendasSessoesBody.appendChild(tr);
        });
    } else {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.classList.add('text-center');
        td.textContent = 'Nenhuma sess√£o registrada (0)';
        tr.appendChild(td);
        vendasSessoesBody.appendChild(tr);
    }
}

        document.getElementById('formFiltrarData').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data_inicial = document.getElementById('dataInicio').value;
            const data_final = document.getElementById('dataFim').value;

            if (!data_inicial || !data_final) {
                Swal.fire('Aviso', 'Por favor, preencha as duas datas.', 'warning');
                return;
            }

            const dados = await buscarDadosDoBackend(data_inicial, data_final);
            atualizarDashboard(dados);

            const modalElement = document.getElementById('modalFiltrarData');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
        });

        window.addEventListener('load', async () => {
            const dados = await buscarDadosDoBackend(null, null);
            atualizarDashboard(dados);
        });
    </script>
    <script>
        document.getElementById('btnBaixarPDF').addEventListener('click', async () => {
    try {
        const response = await fetch('http://127.0.0.1:5000/gerar_pdf_painel', {
            method: 'GET', // ou 'POST' se for necess√°rio
            headers: {
                'Content-Type': 'application/pdf', // pode ser opcional aqui
            }

        });

        if (!response.ok) {
            throw new Error('Erro ao gerar o PDF');
        }

        const blob = await response.blob();

        // Criar URL tempor√°rio
        const url = window.URL.createObjectURL(blob);

        // Criar link para download
        const a = document.createElement('a');
        a.href = url;
        a.download = 'relatorio.pdf'; // nome do arquivo que ser√° baixado
        document.body.appendChild(a);
        a.click();

        // Limpar
        a.remove();
        window.URL.revokeObjectURL(url);

        Swal.fire('Sucesso', 'PDF gerado e baixado com sucesso!', 'success');
    } catch (error) {
        console.error(error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel gerar o PDF.', 'error');
    }
});

    </script>
</body>

</html>